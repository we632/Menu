<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Men√∫ de Snacks</title>
<style>
:root{
  --bg:#f4f5f7;
  --card:#ffffff;
  --brand:#ff7e5f;
  --brand-dark:#d35400;
  --text:#1f2937;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.poster{
  width:100%;
  min-height:100vh;
  background:var(--card);
}
.header{
  background:linear-gradient(135deg,#ff7e5f,#ff9f7f);
  color:#fff;
  text-align:center;
  padding:clamp(24px,5vw,44px) clamp(14px,4vw,30px);
}
.header h1{margin:0;font-size:clamp(2rem,6vw,3.3rem)}
.header p{margin:10px 0 0;font-size:clamp(1rem,2.8vw,1.4rem);opacity:.95}
.content{padding:clamp(16px,4vw,32px)}
.category{margin-bottom:clamp(18px,3vw,30px)}
.category-title{
  margin:0 0 14px;
  padding-bottom:8px;
  border-bottom:3px dashed #ffb199;
  font-size:clamp(1.25rem,3.3vw,2rem);
  color:var(--brand-dark);
}
.item{
  display:grid;
  grid-template-columns:minmax(84px,12vw) 1fr auto auto;
  align-items:center;
  gap:clamp(10px,2.5vw,18px);
  padding:clamp(10px,2.2vw,18px);
  border-radius:14px;
}
.item:nth-child(even){background:#fafafa}
.item a{display:inline-flex}
.item img{
  width:min(100%,120px);
  aspect-ratio:1/1;
  object-fit:contain;
  border-radius:10px;
  background:#fff;
}
.item-name{font-size:clamp(1.02rem,2.4vw,1.55rem);line-height:1.35}
.item-price{
  font-weight:700;
  font-size:clamp(1rem,2.2vw,1.4rem);
  color:#b42318;
  background:#fff1f1;
  padding:8px 14px;
  border-radius:999px;
  white-space:nowrap;
}

.item.is-unorderable img{
  filter:grayscale(100%);
  opacity:.45;
}

.item.is-unorderable{
  background:#f3f4f6 !important;
}

.item.is-unorderable .item-name,
.item.is-unorderable .item-price,
.item.is-unorderable .item-badge{
  opacity:.55;
}
.item-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  margin-left:10px;
  font-size:clamp(.78rem,1.8vw,1rem);
  font-weight:700;
  border-radius:999px;
  padding:5px 10px;
  vertical-align:middle;
}
.item-badge-best{
  color:#8a4b00;
  background:#fff1bf;
}
.item-badge-oos{
  color:#fff;
  background:linear-gradient(135deg,#b91c1c,#dc2626);
  box-shadow:0 8px 16px rgba(185,28,28,.35);
  border:1px solid #991b1b;
  font-weight:900;
  letter-spacing:.25px;
  text-transform:uppercase;
}
.item-badge-soon{
  color:#fff;
  background:linear-gradient(135deg,#b45309,#f59e0b);
  box-shadow:0 8px 16px rgba(180,83,9,.30);
  border:1px solid #92400e;
  font-weight:900;
  letter-spacing:.25px;
  text-transform:uppercase;
}
.item-badge-icon{
  font-size:1.15em;
  line-height:1;
}
.footer{
  text-align:center;
  color:#6b7280;
  padding:18px;
  font-size:clamp(.92rem,2vw,1.15rem);
}
.image-preview{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);padding:16px;z-index:10}
.image-preview.is-open{display:flex}
.image-preview-content{position:relative;background:#fff;padding:12px;border-radius:14px;max-width:96vw;max-height:92vh}
.image-preview-img{max-width:92vw;max-height:84vh;object-fit:contain;border-radius:10px}
.image-preview-close{position:absolute;top:-12px;right:-12px;width:36px;height:36px;border:none;border-radius:50%;background:#ff7e5f;color:#fff;font-size:24px;cursor:pointer}
body.preview-open{overflow:hidden}
@media (max-width:640px){
  .item{grid-template-columns:72px 1fr auto;gap:10px;padding:10px}
  .item img{width:64px}
}
/* ===== Add (+) button on each item ===== */
.item{
  position: relative; /* ‰∏∫Âè≥‰æßÊåâÈíÆÂÆö‰Ωç */
  padding-right: 64px; /* ÁªôÂè≥‰æß‚ûïÁïôÁ©∫Èó¥ */
}

/* ===== Inline Quantity Stepper ===== */



.qty-control{
  display:flex;
  align-items:center;
  gap:6px;
}

.qty-unavailable{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:108px;
  padding:8px 10px;
  border-radius:10px;
  font-size:11px;
  font-weight:900;
  letter-spacing:.35px;
  text-transform:uppercase;
  color:#fff;
  background:linear-gradient(135deg,#6b7280,#374151);
  border:1px solid #1f2937;
  box-shadow:0 6px 12px rgba(31,41,55,.3);
  cursor:not-allowed;
  user-select:none;
}

.qty-unavailable-oos{
  background:linear-gradient(135deg,#b91c1c,#dc2626);
  border-color:#991b1b;
}

.qty-unavailable-soon{
  background:linear-gradient(135deg,#b45309,#f59e0b);
  border-color:#92400e;
}

.qty-btn{
  width: 34px;
  height: 34px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 900;
  font-size: 18px;
  color: #fff;
  background: linear-gradient(135deg, var(--brand), #ff9f7f);
  box-shadow: 0 8px 18px rgba(255,126,95,.25);
}

.qty-btn:disabled{
  opacity:.45;
  cursor:not-allowed;
  box-shadow:none;
}

.qty-btn.minus{
  background: #374151;
}

.qty-number{
  min-width: 24px;
  text-align: center;
  font-weight: 900;
  font-size: 15px;
}

/* ===== Bottom sell bar ===== */
:root{ --sellBarH: 92px; }

.content{
  padding-bottom: calc(clamp(16px,4vw,32px) + var(--sellBarH));
}

.sell-bar{
  position: sticky;
  bottom: 0;
  z-index: 9;
  width: 100%;
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(10px);
  border-top: 1px solid #eee;
}

.sell-bar-inner{
  max-width: 1100px;
  margin: 0 auto;
  padding: 12px clamp(14px,4vw,30px);
  display: grid;
  grid-template-columns: 1fr auto auto;
  gap: 12px;
  align-items: center;
}

.sell-summary-title{
  font-weight: 900;
  letter-spacing: .2px;
}

.sell-summary-sub{
  font-size: 13px;
  color: #6b7280;
  margin-top: 2px;
}

.sell-submit{
  justify-self: center;
  min-width: 140px;
  padding: 12px 22px;
  border: none;
  border-radius: 999px;
  cursor: pointer;
  color: #fff;
  font-weight: 900;
  letter-spacing: .2px;
  background: linear-gradient(135deg, var(--brand), #ff9f7f);
  box-shadow: 0 14px 30px rgba(255,126,95,.30);
}

.sell-submit:disabled{
  opacity: .55;
  cursor: not-allowed;
  box-shadow: none;
}

.sell-clear{
  border: 1px solid #e5e7eb;
  background: #fff;
  color: #374151;
  padding: 12px 14px;
  border-radius: 999px;
  cursor: pointer;
  font-weight: 800;
}

.sell-clear:disabled{
  opacity: .55;
  cursor: not-allowed;
}

/* Â∞èÂ±èÈÄÇÈÖç */
@media (max-width:640px){
  :root{ --sellBarH: 104px; }
  .sell-submit{ min-width: 120px; }
  .item{ padding-right: 58px; }
  .add-btn{ width: 40px; height: 40px; right: 10px; }
  .qty-unavailable{
    min-width: 94px;
    font-size:10px;
    padding:7px 8px;
  }
}
.cart-drawer{
  position:fixed;
  inset:0;
  display:none;
  background:rgba(0,0,0,.3);
  z-index:30;
  opacity: 0;
  transition: opacity .18s ease;
}

.cart-drawer.open{
  display:block;
  opacity: 1;
}
.cart-panel{
  position:absolute;
  right:0;
  top:0;
  height:100%;
  width: min(360px, 92vw);
  background: rgba(255,255,255,.96);
  backdrop-filter: blur(10px);
  box-shadow:-10px 0 30px rgba(0,0,0,.2);
  padding:16px;
  display:flex;
  flex-direction:column;

  transform: translateX(102%);
  transition: transform .22s cubic-bezier(.2,.9,.2,1);
}

.cart-drawer.open .cart-panel{
  transform: translateX(0);
}
/* ÂèØÈÄâÔºöÂÖ≥Èó≠ÊåâÈíÆÊõ¥Â•ΩÁÇπ */
#cartClose{
  border:none;
  background:#fff;
  width:36px;
  height:36px;
  border-radius:999px;
  cursor:pointer;
  font-size:22px;
  line-height:1;
}

.cart-header{
  display:flex;
  justify-content:space-between;
  font-weight:900;
  margin-bottom:10px;
}

.cart-items{
  flex:1;
  overflow:auto;
  font-size:14px;
}

.cart-footer{
  font-weight:900;
  margin-top:10px;
}
.cart-item-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
  padding-bottom:10px;
  border-bottom:1px solid #f1f1f1;
}

.cart-item-img{
  width:60px;
  height:60px;
  object-fit:contain;
  border-radius:8px;
  background:#fff;
}

.cart-item-qty{
  font-weight:900;
  font-size:16px;
}
#cartTotalPrice{
  margin-top:6px;
  font-weight: 900;
  font-size: 18px;
  color: #111827;
}
.cart-actions{
  margin-top: 12px;
  display:flex;
  gap:10px;
}

.cart-gift{
  flex: 1;
  padding: 12px 14px;
  border-radius: 999px;
  border: 1px solid rgba(255,126,95,.35);
  background: rgba(255,126,95,.10);
  color: #b45309;
  font-weight: 900;
  cursor: pointer;
}
.cart-gift:disabled{
  opacity: .55;
  cursor: not-allowed;
}
</style>
</head>
<body>
<div class="poster">
  <div class="header">
    <h1>Men√∫ de Snacks</h1>
    <p>R√°pido ¬∑ F√°cil ¬∑ Delicioso</p>
  </div>

  <div class="content">
    <div id="menuRoot"></div>
  </div>

  <div class="image-preview" aria-hidden="true">
    <div class="image-preview-content" role="dialog" aria-modal="true" aria-label="Vista previa de imagen">
      <button class="image-preview-close" type="button" aria-label="Cerrar vista previa">√ó</button>
      <img class="image-preview-img" alt="">
    </div>
  </div>


  <div class="footer">Inventario fresco ¬∑ Listo para llevar</div>
 <!-- Bottom Sell Bar -->
 <div id="cartDrawer" class="cart-drawer">
  <div class="cart-panel">
    <div class="cart-header">
      <div>Cart Preview</div>
      <button id="cartClose">√ó</button>
    </div>

    <div id="cartItems" class="cart-items"></div>

    <div class="cart-footer">
      <div id="cartTotal"></div>
      <div id="cartTotalPrice"></div>

      <div class="cart-actions">
        <button id="giftSubmit" class="cart-gift" type="button">Gift</button>
      </div>
    </div>
  </div>
 </div>
 <div class="sell-bar" role="region" aria-label="Sell bar">
  <div class="sell-bar-inner">
    <div class="sell-summary">
      <div class="sell-summary-title">Cart</div>
      <div class="sell-summary-sub" id="sellSummaryText">No items selected</div>
    </div>

    <button id="sellSubmit" class="sell-submit" type="button" disabled>
      Sell
    </button>

    <button id="clearCart" class="sell-clear" type="button" disabled>
      Clear
    </button>
  </div>
</div>
</div>

<script>
/** =========================
 *  CONFIG
 * ========================= */
const API_BASE = (() => {
  const fromQuery = new URLSearchParams(window.location.search).get("api");
  if (fromQuery) return fromQuery.replace(/\/+$/, "");

  const isLocalHost = /^(localhost|127\.0\.0\.1)$/.test(window.location.hostname);
  if (window.location.protocol.startsWith("http") && isLocalHost){
    return `${window.location.protocol}//${window.location.hostname}:8000`;
  }

  return "https://menu-backend-8s25.onrender.com";
})(); // Êú¨Âú∞Ëá™Âä®Ëµ∞ :8000ÔºõÁ∫ø‰∏äÈªòËÆ§Ëµ∞ Render
const API_KEY  = "4f93kKz8LmPq21XyN7uQaBcD"; // ‚úÖ ‰Ω†Áé∞Âú®ÁöÑ keyÔºàÊ≥®ÊÑèÔºöGitHub Pages ‰ºöÊö¥Èú≤ÂÆÉÔºâ
const menuRoot = document.getElementById("menuRoot");

// Excel ‰ΩøÁî®Ëã±ÊñáÂàÜÁ±ª
const CATEGORY_ORDER = [
  "cookies",
  "chips",
  "candy",
  "protein",
  "drinks",
  "gum",
];

// ÂàÜÁ±ªÊòæÁ§∫ÈÖçÁΩÆÔºöÂÖàÊåâÊ†áÂáÜÂàÜÁ±ªÊò†Â∞ÑÔºõÊú™Áü•ÂàÜÁ±ªËµ∞Â§áÁî®ÂõæÊ†áÊ±†
const SHOW_CATEGORY_ICON = true;
const CATEGORY_META = {
  cookies: { icon: "üç™", label: "Galletas y dulces horneados" },
  chips: { icon: "ü•î", label: "Papas y botanas crujientes" },
  candy: { icon: "üç¨", label: "Dulces y chocolates" },
  protein: { icon: "üí™", label: "Barras de prote√≠na" },
  drinks: { icon: "ü•§", label: "Bebidas" },
  gum: { icon: "üçÉ", label: "Chicles" },
};
const FALLBACK_CATEGORY_ICONS = ["üß∫", "üç±", "üçø", "üç©", "ü•®", "üßÉ", "üçì", "ü•ú", "üç´", "üßÅ"];

function normalizeCategoryKey(v){
  return String(v || "").trim().toLowerCase();
}

function pickFallbackCategoryIcon(category){
  let hash = 0;
  const s = String(category || "");
  for (let i = 0; i < s.length; i++) hash = ((hash << 5) - hash) + s.charCodeAt(i);
  const idx = Math.abs(hash) % FALLBACK_CATEGORY_ICONS.length;
  return FALLBACK_CATEGORY_ICONS[idx];
}

function getCategoryLabelHtml(category){
  const raw = String(category || "Other").trim() || "Other";
  const key = normalizeCategoryKey(raw);
  const meta = CATEGORY_META[key];
  const text = meta ? meta.label : raw;
  if (!SHOW_CATEGORY_ICON) return escapeHtml(text);
  const icon = meta ? meta.icon : pickFallbackCategoryIcon(raw);
  return `${icon} ${escapeHtml(text)}`;
}

function getCategoryOrderIndex(category){
  return CATEGORY_ORDER.indexOf(normalizeCategoryKey(category));
}

function fmtPrice(n){
  const v = Number(n);
  return Number.isFinite(v) ? `$${v.toFixed(2)}` : "$0.00";
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function parsePrice(text){
  const n = Number(String(text || "").replace(/[^0-9.]/g, ""));
  return Number.isFinite(n) ? n : 0;
}

function isUnavailableBadgeText(text){
  const badgeText = String(text || "").trim().toLowerCase();
  if (!badgeText) return false;
  return /out\s*of\s*stock|coming\s*up\s*soon|coming\s*soon|non[-\s]?orderable|sold\s*out|unavailable/.test(badgeText);
}

function isComingSoonBadgeText(text){
  const badgeText = String(text || "").trim().toLowerCase();
  if (!badgeText) return false;
  return /coming\s*up\s*soon|coming\s*soon/.test(badgeText);
}

function getBadgeMeta(product){
  const badgeText = String(product?.badge || "").trim();
  const stockStatus = String(product?.stock_status || "").toLowerCase();
  const isOutByStatus = stockStatus === "out_of_stock" || stockStatus === "non_orderable";
  const isOutByFlag = product?.orderable === false || product?.is_orderable === false;
  const isOutByText = isUnavailableBadgeText(badgeText);
  const isOutOfStock = isOutByStatus || isOutByFlag || isOutByText;
  const isComingSoon = isComingSoonBadgeText(badgeText);

  if (isOutOfStock){
    return {
      type: isComingSoon ? "soon" : "oos",
      text: badgeText || (isComingSoon ? "Coming Up Soon" : "Out of Stock"),
      icon: isComingSoon ? "üîú" : "‚õî",
      unavailable: true,
    };
  }

  if (!badgeText) return null;

  return {
    type: "best",
    text: badgeText,
    icon: "‚≠ê"
  };
}

/** =========================
 *  CART + QTY
 * ========================= */
const cart = {}; // { sku: qty }
const productMetaBySku = new Map();

function getQty(sku){ return cart[sku] || 0; }

function setQty(sku, qty){
  const meta = productMetaBySku.get(String(sku));
  if (meta && meta.orderable === false){
    delete cart[sku];
    updateUI();
    return;
  }

  const q = Math.max(0, Math.floor(Number(qty) || 0));
  if (q === 0) delete cart[sku];
  else cart[sku] = q;

  updateUI();
  if (cartDrawer.classList.contains("open")) renderCartPreview();
}

function updateQtyControls(){
  document.querySelectorAll(".item[data-sku]").forEach(item=>{
    const sku = item.dataset.sku;
    const container = item.querySelector(".qty-control");
    if (!container) return;

    const orderable = item.dataset.orderable !== "false";
    if (!orderable){
      const meta = productMetaBySku.get(String(sku));
      const reason = String(meta?.unavailableLabel || "Unavailable");
      const unavailableType = String(meta?.unavailableType || "").toLowerCase();
      const typeClass = unavailableType ? ` qty-unavailable-${unavailableType}` : "";
      const text = unavailableType === "soon"
        ? "COMING SOON"
        : (unavailableType === "oos" ? "OUT OF STOCK" : "UNAVAILABLE");
      container.innerHTML = `<span class="qty-unavailable${typeClass}" title="${escapeHtml(reason)}">${text}</span>`;
      return;
    }

    const qty = getQty(sku);
    if (qty === 0){
      container.innerHTML = `<button class="qty-btn plus" type="button">+</button>`;
    } else {
      container.innerHTML = `
        <button class="qty-btn minus" type="button">‚àí</button>
        <div class="qty-number">${qty}</div>
        <button class="qty-btn plus" type="button">+</button>
      `;
    }
  });
}

/** Âè™ÂÖÅËÆ∏ÁÇπ + / - ÊîπÊï∞ÈáèÔºàÁÇπÂà´ÁöÑÂú∞Êñπ‰∏ç‰∫§‰∫íÔºâ */
document.addEventListener("click",(e)=>{
  const plus = e.target.closest(".qty-btn.plus");
  const minus = e.target.closest(".qty-btn.minus");
  if (!plus && !minus) return;

  const item = e.target.closest(".item[data-sku]");
  if (!item) return;

  e.preventDefault();
  e.stopPropagation();

  const sku = item.dataset.sku;
  if (item.dataset.orderable === "false") return;
  if (plus) setQty(sku, getQty(sku) + 1);
  if (minus) setQty(sku, getQty(sku) - 1);
});

/** =========================
 *  Bottom bar + Drawer
 * ========================= */
const summaryTextEl = document.getElementById("sellSummaryText");
const sellBtnEl = document.getElementById("sellSubmit");
const clearBtnEl = document.getElementById("clearCart");
const giftBtnEl = document.getElementById("giftSubmit");

const cartDrawer = document.getElementById("cartDrawer");
const cartClose = document.getElementById("cartClose");
const cartItemsEl = document.getElementById("cartItems");
const cartTotalEl = document.getElementById("cartTotal");
const cartTotalPriceEl = document.getElementById("cartTotalPrice");
let summaryOverrideText = "";
let summaryOverrideTimer = null;

/** ÁÇπ Cart ÊâçÊâìÂºÄ drawer */
document.querySelector(".sell-summary").addEventListener("click",()=>{
  if(Object.keys(cart).length === 0) return;
  renderCartPreview();
  cartDrawer.classList.add("open");
});

cartClose.addEventListener("click",()=> cartDrawer.classList.remove("open"));
cartDrawer.addEventListener("click",(e)=>{
  if(e.target === cartDrawer) cartDrawer.classList.remove("open");
});

function updateUI(){
  for (const sku of Object.keys(cart)){
    const meta = productMetaBySku.get(String(sku));
    if (meta && meta.orderable === false) delete cart[sku];
  }

  updateQtyControls();

  const totalQty = Object.values(cart).reduce((a,b)=>a+b,0);
  let defaultSummary = "No items selected";

  const hasUnorderableInCart = Object.keys(cart).some((sku)=>{
    const meta = productMetaBySku.get(String(sku));
    return meta?.orderable === false;
  });

  if(totalQty === 0 || hasUnorderableInCart){
    sellBtnEl.disabled = true;
    clearBtnEl.disabled = true;
    if (giftBtnEl) giftBtnEl.disabled = true;
  }else{
    defaultSummary = `${totalQty} item(s)`;
    sellBtnEl.disabled = false;
    clearBtnEl.disabled = false;
    if (giftBtnEl) giftBtnEl.disabled = false;
  }

  summaryTextEl.textContent = summaryOverrideText || defaultSummary;
}

function setSummaryOverride(text, durationMs = 0){
  summaryOverrideText = String(text || "").trim();
  if (summaryOverrideTimer){
    clearTimeout(summaryOverrideTimer);
    summaryOverrideTimer = null;
  }
  updateUI();
  if (durationMs > 0){
    summaryOverrideTimer = setTimeout(()=>{
      summaryOverrideText = "";
      summaryOverrideTimer = null;
      updateUI();
    }, durationMs);
  }
}

function renderCartPreview(){
  cartItemsEl.innerHTML = "";
  let totalQty = 0;
  let totalPrice = 0;

  Object.keys(cart).forEach(sku=>{
    const qty = cart[sku];
    totalQty += qty;

    const item = document.querySelector(`.item[data-sku="${sku}"]`);
    if (!item) return;

    const imgEl = item.querySelector("img");
    const priceText = item.querySelector(".item-price")?.textContent || "";
    const unitPrice = parsePrice(priceText);
    totalPrice += unitPrice * qty;

    const wrapper = document.createElement("div");
    wrapper.className = "cart-item-row";
    wrapper.innerHTML = `
      <img src="${imgEl?.src || ""}" class="cart-item-img" alt="">
      <div class="cart-item-qty">√ó ${qty}</div>
    `;
    cartItemsEl.appendChild(wrapper);
  });

  cartTotalEl.textContent = `Total Items: ${totalQty}`;
  cartTotalPriceEl.textContent = `Total Price: $${totalPrice.toFixed(2)}`;
}

/** Clear */
clearBtnEl.addEventListener("click",()=>{
  for(const k of Object.keys(cart)) delete cart[k];
  updateUI();
  if (cartDrawer.classList.contains("open")) renderCartPreview();
});

/** =========================
 *  Sell / Gift (Batch)
 * ========================= */
async function postJson(url, body, extraHeaders = {}){
  const res = await fetch(url, {
    method:"POST",
    headers: { "Content-Type":"application/json", ...extraHeaders },
    body: JSON.stringify(body),
  });
  const data = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(data.detail || "Request failed");
  return data;
}

sellBtnEl.addEventListener("click", async ()=>{
  const skus = Object.keys(cart);
  if(!skus.length) return;

  // Â¶ÇÊûú‰Ω†ÂêéÁ´ØÊúâ PIN Ê†°È™åÂ∞±‰øùÁïôÔºõÊ≤°ÊúâÂ∞±Âà†ÊéâËøô 3 Ë°å
  const pin = prompt("Enter PIN to confirm sale:");
  if (!pin) return;

  const items = skus.map(sku => ({ sku, qty: cart[sku] }));

  sellBtnEl.disabled = true;
  clearBtnEl.disabled = true;
  setSummaryOverride("Submitting...");

  try{
    await postJson(apiUrl("api/sales/batch"), {
      items,
      request_id: crypto.randomUUID(),
      note: ""
    }, {
      "X-Sell-Pin": pin
    });

    for(const k of Object.keys(cart)) delete cart[k];
    updateUI();
    if (cartDrawer.classList.contains("open")) cartDrawer.classList.remove("open");

    setSummaryOverride("Sold ‚úì", 1200);
  }catch(err){
    setSummaryOverride(err?.message || "Sell failed", 3000);
  }finally{
    updateUI();
  }
});

giftBtnEl?.addEventListener("click", async ()=>{
  const skus = Object.keys(cart);
  if(!skus.length) return;

  const pin = prompt("Enter PIN to confirm gift:");
  if (!pin) return;

  giftBtnEl.disabled = true;
  setSummaryOverride("Submitting gift...");

  try{
    const items = skus.map(sku => ({ sku, qty: cart[sku] }));

    await postJson(apiUrl("api/losses/batch"), {
      items,
      request_id: crypto.randomUUID(),
      loss_type: "GIFT",
      note: ""
    }, {
      "X-Sell-Pin": pin
    });

    for(const k of Object.keys(cart)) delete cart[k];
    updateUI();
    if (cartDrawer.classList.contains("open")) cartDrawer.classList.remove("open");

    setSummaryOverride("Gift recorded ‚úì", 1200);
  }catch(err){
    setSummaryOverride(err?.message || "Gift failed", 3000);
  }finally{
    updateUI();
  }
});

/** =========================
 *  Image preview (delegation)
 *  ÂÖ≥ÈîÆÔºöÂõ†‰∏∫ item ÊòØÂä®ÊÄÅÁîüÊàêÁöÑ
 * ========================= */
const preview = document.querySelector('.image-preview');
const previewImage = document.querySelector('.image-preview-img');
const previewClose = document.querySelector('.image-preview-close');

function closePreview(){
  preview.classList.remove('is-open');
  preview.setAttribute('aria-hidden', 'true');
  previewImage.src = '';
  previewImage.alt = '';
  document.body.classList.remove('preview-open');
}

document.addEventListener("click", (event) => {
  const link = event.target.closest(".item a");
  if (!link) return;

  event.preventDefault();
  const img = link.querySelector("img");
  previewImage.src = link.getAttribute("href");
  previewImage.alt = img ? img.alt : "Vista previa";
  preview.classList.add("is-open");
  preview.setAttribute("aria-hidden","false");
  document.body.classList.add("preview-open");
});

preview.addEventListener('click', (event) => {
  if (event.target === preview) closePreview();
});
previewClose.addEventListener('click', closePreview);
document.addEventListener('keydown', (event) => {
  if (event.key === 'Escape' && preview.classList.contains('is-open')) closePreview();
});

/** =========================
 *  AUTO RENDER MENU
 * ========================= */
function apiUrl(path){
  const normalizedPath = String(path || "").replace(/^\/+/, "");
  return `${API_BASE}/${normalizedPath}`;
}

async function loadProducts(){
  const endpoint = apiUrl("api/products");
  const attempts = [
    {
      label: "header-auth",
      url: endpoint,
      options: { headers: { "X-API-Key": API_KEY } }
    },
    {
      label: "query-auth",
      url: `${endpoint}?api_key=${encodeURIComponent(API_KEY)}`,
      options: {}
    },
    {
      label: "public",
      url: endpoint,
      options: {}
    }
  ];

  const errors = [];

  for (const attempt of attempts){
    try{
      const res = await fetch(attempt.url, attempt.options);
      if (res.ok) return await res.json(); // [{sku,name,category,sell_price,image_url,badge}]

      const reason = (await res.text().catch(()=>"")).trim();
      errors.push(`${attempt.label}: ${res.status}${reason ? ` ${reason}` : ""}`);

      if (res.status !== 401 && res.status !== 403) break;
    }catch(err){
      errors.push(`${attempt.label}: ${err?.message || "network error"}`);
    }
  }

  throw new Error(`Failed to load products (${errors.join(" | ")})`);
}

function groupByCategory(products){
  const map = new Map();
  for (const p of products){
    const cat = String(p.category || "Other").trim();
    if (!map.has(cat)) map.set(cat, []);
    map.get(cat).push(p);
  }
  return map;
}

function sortCategories(cats){
  return cats.sort((a,b)=>{
    const ia = getCategoryOrderIndex(a);
    const ib = getCategoryOrderIndex(b);
    if (ia === -1 && ib === -1) return a.localeCompare(b);
    if (ia === -1) return 1;
    if (ib === -1) return -1;
    return ia - ib;
  });
}

function renderMenu(products){
  productMetaBySku.clear();

  const groups = groupByCategory(products);
  const categories = sortCategories(Array.from(groups.keys()));

  menuRoot.innerHTML = "";

  for (const cat of categories){
    const label = getCategoryLabelHtml(cat);

    const catDiv = document.createElement("div");
    catDiv.className = "category";
    catDiv.innerHTML = `<h2 class="category-title">${label}</h2>`;  

    const items = groups.get(cat) || [];
    items.sort((x,y)=> String(x.sku).localeCompare(String(y.sku)));

    for (const p of items){
      const badge = getBadgeMeta(p);
      const badgeText = badge?.text || "";
      const badgeHtml = badge
        ? `<span class="item-badge item-badge-${badge.type}"><span class="item-badge-icon" aria-hidden="true">${badge.icon}</span>${escapeHtml(badge.text)}</span>`
        : "";

      const imgUrl = String(p.image_url || "").trim();
      const orderableByFlag = p.orderable !== false && p.is_orderable !== false;
      const orderableByBadge = !(badge && badge.unavailable === true);
      const orderable = orderableByFlag && orderableByBadge;

      productMetaBySku.set(String(p.sku), {
        orderable,
        badge: badgeText,
        unavailableType: badge?.type || "",
        unavailableLabel: badge?.text || (orderable ? "" : "Unavailable"),
      });

      const item = document.createElement("div");
      item.className = `item${orderable ? "" : " is-unorderable"}`;
      item.setAttribute("data-sku", p.sku);
      item.setAttribute("data-orderable", orderable ? "true" : "false");

      item.innerHTML = `
        <a href="${escapeHtml(imgUrl)}">
          <img loading="lazy" src="${escapeHtml(imgUrl)}" alt="${escapeHtml(p.name)}">
        </a>
        <div class="item-name">${escapeHtml(p.name)} ${badgeHtml}</div>
        <div class="item-price">${fmtPrice(p.sell_price)}</div>
        <div class="qty-control"></div>
      `;

      catDiv.appendChild(item);
    }

    menuRoot.appendChild(catDiv);
  }

  updateUI();
}

(async function init(){
  try{
    const products = await loadProducts();
    renderMenu(products);
    updateUI();
  }catch(e){
    console.error(e);
    menuRoot.innerHTML = `<div style="padding:16px;font-weight:900;">Failed to load menu.</div>`;
  }
})();
</script>
</body>
</html>

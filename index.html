<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Men√∫ de Snacks</title>
<style>
:root{
  --bg:#f4f5f7;
  --card:#ffffff;
  --brand:#ff7e5f;
  --brand-dark:#d35400;
  --text:#1f2937;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.poster{
  width:100%;
  min-height:100vh;
  background:var(--card);
}
.header{
  background:linear-gradient(135deg,#ff7e5f,#ff9f7f);
  color:#fff;
  text-align:center;
  padding:clamp(24px,5vw,44px) clamp(14px,4vw,30px);
}
.header h1{margin:0;font-size:clamp(2rem,6vw,3.3rem)}
.header p{margin:10px 0 0;font-size:clamp(1rem,2.8vw,1.4rem);opacity:.95}
.content{padding:clamp(16px,4vw,32px)}
.category{margin-bottom:clamp(18px,3vw,30px)}
.category-title{
  margin:0 0 14px;
  padding-bottom:8px;
  border-bottom:3px dashed #ffb199;
  font-size:clamp(1.25rem,3.3vw,2rem);
  color:var(--brand-dark);
}
.item{
  display:grid;
  grid-template-columns:minmax(84px,12vw) 1fr auto auto;
  align-items:center;
  gap:clamp(10px,2.5vw,18px);
  padding:clamp(10px,2.2vw,18px);
  border-radius:14px;
}
.item:nth-child(even){background:#fafafa}
.item a{display:inline-flex}
.item img{
  width:min(100%,120px);
  aspect-ratio:1/1;
  object-fit:contain;
  border-radius:10px;
  background:#fff;
}
.item-name{font-size:clamp(1.02rem,2.4vw,1.55rem);line-height:1.35}
.item-price{
  font-weight:700;
  font-size:clamp(1rem,2.2vw,1.4rem);
  color:#b42318;
  background:#fff1f1;
  padding:8px 14px;
  border-radius:999px;
  white-space:nowrap;
}

.item.is-unorderable img{
  filter:none;
  opacity:1;
}

.item.is-unorderable{
  background:inherit;
}

.item.is-unorderable .item-name,
.item.is-unorderable .item-price,
.item.is-unorderable .item-badge{
  opacity:1;
}

/* promotion Âè™Á¶ÅÊ≠¢‰∏ãÂçïÔºå‰∏çÂÅöÁÅ∞ÂåñÂ§ÑÁêÜ */
.item.is-unorderable.is-promo-display{
  background:#fff7ed !important;
  border:1px dashed #f2c094;
}

.item.is-unorderable.is-promo-display img{
  filter:none;
  opacity:1;
}

.item.is-unorderable.is-promo-display .item-name,
.item.is-unorderable.is-promo-display .item-price,
.item.is-unorderable.is-promo-display .item-badge{
  opacity:1;
}
.item-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  margin-left:10px;
  font-size:clamp(.78rem,1.8vw,1rem);
  font-weight:700;
  border-radius:999px;
  padding:5px 10px;
  vertical-align:middle;
}
.item-badge-best{
  color:#8a4b00;
  background:#fff1bf;
}
.item-badge-oos{
  color:#fff;
  background:linear-gradient(135deg,#b91c1c,#dc2626);
  box-shadow:0 8px 16px rgba(185,28,28,.35);
  border:1px solid #991b1b;
  font-weight:900;
  letter-spacing:.25px;
  text-transform:uppercase;
}
.item-badge-soon{
  color:#fff;
  background:linear-gradient(135deg,#b45309,#f59e0b);
  box-shadow:0 8px 16px rgba(180,83,9,.30);
  border:1px solid #92400e;
  font-weight:900;
  letter-spacing:.25px;
  text-transform:uppercase;
}
.item-badge-icon{
  font-size:1.15em;
  line-height:1;
}
.footer{
  text-align:center;
  color:#6b7280;
  padding:18px;
  font-size:clamp(.92rem,2vw,1.15rem);
}
.image-preview{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);padding:16px;z-index:10}
.image-preview.is-open{display:flex}
.image-preview-content{position:relative;background:#fff;padding:12px;border-radius:14px;max-width:96vw;max-height:92vh}
.image-preview-img{max-width:92vw;max-height:84vh;object-fit:contain;border-radius:10px}
.image-preview-close{position:absolute;top:-12px;right:-12px;width:36px;height:36px;border:none;border-radius:50%;background:#ff7e5f;color:#fff;font-size:24px;cursor:pointer}
body.preview-open{overflow:hidden}
@media (max-width:640px){
  .item{grid-template-columns:72px 1fr auto;gap:10px;padding:10px}
  .item img{width:64px}
}
/* ===== Add (+) button on each item ===== */
.item{
  position: relative; /* ‰∏∫Âè≥‰æßÊåâÈíÆÂÆö‰Ωç */
  padding-right: 64px; /* ÁªôÂè≥‰æß‚ûïÁïôÁ©∫Èó¥ */
}

/* ===== Inline Quantity Stepper ===== */



.qty-control{
  display:flex;
  align-items:center;
  gap:6px;
}

.qty-unavailable{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:108px;
  padding:8px 10px;
  border-radius:10px;
  font-size:11px;
  font-weight:900;
  letter-spacing:.35px;
  text-transform:uppercase;
  color:#fff;
  background:linear-gradient(135deg,#6b7280,#374151);
  border:1px solid #1f2937;
  box-shadow:0 6px 12px rgba(31,41,55,.3);
  cursor:not-allowed;
  user-select:none;
}

.qty-unavailable-oos{
  background:linear-gradient(135deg,#b91c1c,#dc2626);
  border-color:#991b1b;
}

.qty-unavailable-soon{
  background:linear-gradient(135deg,#b45309,#f59e0b);
  border-color:#92400e;
}

.qty-unavailable-promo{
  background:linear-gradient(135deg,#c2410c,#fb923c);
  border-color:#9a3412;
}

.qty-btn{
  width: 34px;
  height: 34px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 900;
  font-size: 18px;
  color: #fff;
  background: linear-gradient(135deg, var(--brand), #ff9f7f);
  box-shadow: 0 8px 18px rgba(255,126,95,.25);
}

.qty-btn:disabled{
  opacity:.45;
  cursor:not-allowed;
  box-shadow:none;
}

.qty-btn.minus{
  background: #374151;
}

.qty-number{
  min-width: 24px;
  text-align: center;
  font-weight: 900;
  font-size: 15px;
}

/* ===== Bottom sell bar ===== */
:root{ --sellBarH: 92px; }

.content{
  padding-bottom: calc(clamp(16px,4vw,32px) + var(--sellBarH));
}

.sell-bar{
  position: sticky;
  bottom: 0;
  z-index: 9;
  width: 100%;
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(10px);
  border-top: 1px solid #eee;
}

.sell-bar-inner{
  max-width: 1100px;
  margin: 0 auto;
  padding: 12px clamp(14px,4vw,30px);
  display: grid;
  grid-template-columns: 1fr auto auto auto;
  gap: 12px;
  align-items: center;
}

.sell-summary-title{
  font-weight: 900;
  letter-spacing: .2px;
}

.sell-summary-sub{
  font-size: 13px;
  color: #6b7280;
  margin-top: 2px;
}

.sell-submit{
  justify-self: center;
  min-width: 140px;
  padding: 12px 22px;
  border: none;
  border-radius: 999px;
  cursor: pointer;
  color: #fff;
  font-weight: 900;
  letter-spacing: .2px;
  background: linear-gradient(135deg, var(--brand), #ff9f7f);
  box-shadow: 0 14px 30px rgba(255,126,95,.30);
}

.sell-submit:disabled{
  opacity: .55;
  cursor: not-allowed;
  box-shadow: none;
}

.sell-promo{
  border: 1px solid #f2c094;
  background: #fff7ed;
  color: #9a3412;
  padding: 12px 16px;
  border-radius: 999px;
  cursor: pointer;
  font-weight: 900;
}

.sell-promo:disabled{
  opacity:.55;
  cursor:not-allowed;
}

.sell-clear{
  border: 1px solid #e5e7eb;
  background: #fff;
  color: #374151;
  padding: 12px 14px;
  border-radius: 999px;
  cursor: pointer;
  font-weight: 800;
}

.sell-clear:disabled{
  opacity: .55;
  cursor: not-allowed;
}

/* Â∞èÂ±èÈÄÇÈÖç */
@media (max-width:640px){
  :root{ --sellBarH: 104px; }
  .sell-submit{ min-width: 120px; }
  .sell-promo{ min-width: 114px; }
  .item{ padding-right: 58px; }
  .add-btn{ width: 40px; height: 40px; right: 10px; }
  .qty-unavailable{
    min-width: 94px;
    font-size:10px;
    padding:7px 8px;
  }
  .promo-form{
    grid-template-columns:1fr;
  }
}
.cart-drawer{
  position:fixed;
  inset:0;
  display:none;
  background:rgba(0,0,0,.3);
  z-index:30;
  opacity: 0;
  transition: opacity .18s ease;
}

.cart-drawer.open{
  display:block;
  opacity: 1;
}
.cart-panel{
  position:absolute;
  right:0;
  top:0;
  height:100%;
  width: min(360px, 92vw);
  background: rgba(255,255,255,.96);
  backdrop-filter: blur(10px);
  box-shadow:-10px 0 30px rgba(0,0,0,.2);
  padding:16px;
  display:flex;
  flex-direction:column;

  transform: translateX(102%);
  transition: transform .22s cubic-bezier(.2,.9,.2,1);
}

.cart-drawer.open .cart-panel{
  transform: translateX(0);
}
/* ÂèØÈÄâÔºöÂÖ≥Èó≠ÊåâÈíÆÊõ¥Â•ΩÁÇπ */
#cartClose{
  border:none;
  background:#fff;
  width:36px;
  height:36px;
  border-radius:999px;
  cursor:pointer;
  font-size:22px;
  line-height:1;
}

.cart-header{
  display:flex;
  justify-content:space-between;
  font-weight:900;
  margin-bottom:10px;
}

.cart-items{
  flex:1;
  overflow:auto;
  font-size:14px;
}

.cart-footer{
  font-weight:900;
  margin-top:10px;
}
.cart-item-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
  padding-bottom:10px;
  border-bottom:1px solid #f1f1f1;
}

.cart-item-img{
  width:60px;
  height:60px;
  object-fit:contain;
  border-radius:8px;
  background:#fff;
}

.cart-item-qty{
  font-weight:900;
  font-size:16px;
}
#cartTotalPrice{
  margin-top:6px;
  font-weight: 900;
  font-size: 18px;
  color: #111827;
}
#cartDiscountPrice{
  margin-top:4px;
  font-weight:800;
  font-size:14px;
  color:#9a3412;
}
.cart-actions{
  margin-top: 12px;
  display:flex;
  gap:10px;
}

.cart-gift{
  flex: 1;
  padding: 12px 14px;
  border-radius: 999px;
  border: 1px solid rgba(255,126,95,.35);
  background: rgba(255,126,95,.10);
  color: #b45309;
  font-weight: 900;
  cursor: pointer;
}
.cart-gift:disabled{
  opacity: .55;
  cursor: not-allowed;
}

.promo-modal{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(17,24,39,.45);
  z-index:40;
  padding:16px;
}

.promo-modal.open{
  display:flex;
}

.promo-panel{
  width:min(460px,96vw);
  background:#fff;
  border-radius:16px;
  padding:16px;
  box-shadow:0 20px 45px rgba(0,0,0,.22);
}

.promo-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}

.promo-title{
  font-weight:900;
  color:#9a3412;
}

#promotionClose{
  border:none;
  background:#fff;
  width:32px;
  height:32px;
  border-radius:999px;
  cursor:pointer;
  font-size:22px;
  line-height:1;
}

.promo-form{
  display:grid;
  grid-template-columns: 1fr 130px auto;
  gap:10px;
  align-items:end;
}

.promo-field{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.promo-label{
  font-size:12px;
  color:#6b7280;
  font-weight:700;
}

.promo-input{
  border:1px solid #e5e7eb;
  border-radius:10px;
  padding:10px 12px;
  font-size:14px;
}

.promo-apply{
  border:none;
  border-radius:10px;
  padding:10px 14px;
  font-weight:900;
  background:linear-gradient(135deg,#fb923c,#f97316);
  color:#fff;
  cursor:pointer;
}

.promo-list{
  margin-top:12px;
  border-top:1px solid #f3f4f6;
  padding-top:10px;
  max-height:220px;
  overflow:auto;
}

.promo-empty{
  font-size:13px;
  color:#6b7280;
}

.promo-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:8px 0;
  border-bottom:1px dashed #f1f1f1;
}

.promo-item-main{
  min-width:0;
}

.promo-item-name{
  font-size:13px;
  font-weight:800;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.promo-item-meta{
  font-size:12px;
  color:#6b7280;
}

.promo-item-remove{
  border:1px solid #e5e7eb;
  background:#fff;
  color:#374151;
  border-radius:999px;
  padding:6px 10px;
  cursor:pointer;
  font-weight:800;
}
</style>
</head>
<body>
<div class="poster">
  <div class="header">
    <h1>Men√∫ de Snacks</h1>
    <p>R√°pido ¬∑ F√°cil ¬∑ Delicioso</p>
  </div>

  <div class="content">
    <div id="menuRoot"></div>
  </div>

  <div class="image-preview" aria-hidden="true">
    <div class="image-preview-content" role="dialog" aria-modal="true" aria-label="Vista previa de imagen">
      <button class="image-preview-close" type="button" aria-label="Cerrar vista previa">√ó</button>
      <img class="image-preview-img" alt="">
    </div>
  </div>


  <div class="footer">Inventario fresco ¬∑ Listo para llevar</div>
 <!-- Bottom Sell Bar -->
 <div id="cartDrawer" class="cart-drawer">
  <div class="cart-panel">
    <div class="cart-header">
      <div>Cart Preview</div>
      <button id="cartClose">√ó</button>
    </div>

    <div id="cartItems" class="cart-items"></div>

    <div class="cart-footer">
      <div id="cartTotal"></div>
      <div id="cartTotalPrice"></div>
      <div id="cartDiscountPrice"></div>

      <div class="cart-actions">
        <button id="giftSubmit" class="cart-gift" type="button">Gift</button>
      </div>
    </div>
  </div>
 </div>
 <div class="sell-bar" role="region" aria-label="Sell bar">
  <div class="sell-bar-inner">
    <div class="sell-summary">
      <div class="sell-summary-title">Cart</div>
      <div class="sell-summary-sub" id="sellSummaryText">No items selected</div>
    </div>

    <button id="sellSubmit" class="sell-submit" type="button" disabled>
      Sell
    </button>

    <button id="promotionOpen" class="sell-promo" type="button" disabled>
      Promotion
    </button>

    <button id="clearCart" class="sell-clear" type="button" disabled>
      Clear
    </button>
  </div>
</div>

<div id="promotionModal" class="promo-modal" aria-hidden="true">
  <div class="promo-panel" role="dialog" aria-modal="true" aria-label="Promotion discount">
    <div class="promo-header">
      <div class="promo-title">Promotion Discount</div>
      <button id="promotionClose" type="button" aria-label="Close promotion">√ó</button>
    </div>

    <div class="promo-form">
      <div class="promo-field">
        <label class="promo-label" for="promotionSkuSelect">Cart Product</label>
        <select id="promotionSkuSelect" class="promo-input"></select>
      </div>
      <div class="promo-field">
        <label class="promo-label" for="promotionAmountInput">Discount ($)</label>
        <input id="promotionAmountInput" class="promo-input" type="number" min="0.01" step="0.01" placeholder="0.00">
      </div>
      <button id="promotionApply" class="promo-apply" type="button">Apply</button>
    </div>

    <div id="promotionList" class="promo-list"></div>
  </div>
</div>
</div>

<script>
/** =========================
 *  CONFIG
 * ========================= */
const API_BASE = (() => {
  const fromQuery = new URLSearchParams(window.location.search).get("api");
  if (fromQuery) return fromQuery.replace(/\/+$/, "");

  const isLocalHost = /^(localhost|127\.0\.0\.1)$/.test(window.location.hostname);
  if (window.location.protocol.startsWith("http") && isLocalHost){
    return `${window.location.protocol}//${window.location.hostname}:8000`;
  }

  return "https://menu-backend-8s25.onrender.com";
})(); // Êú¨Âú∞Ëá™Âä®Ëµ∞ :8000ÔºõÁ∫ø‰∏äÈªòËÆ§Ëµ∞ Render
const API_KEY  = "4f93kKz8LmPq21XyN7uQaBcD"; // ‚úÖ ‰Ω†Áé∞Âú®ÁöÑ keyÔºàÊ≥®ÊÑèÔºöGitHub Pages ‰ºöÊö¥Èú≤ÂÆÉÔºâ
const menuRoot = document.getElementById("menuRoot");

// Excel ‰ΩøÁî®Ëã±ÊñáÂàÜÁ±ª
const CATEGORY_ORDER = [
  "promotion",
  "cookies",
  "chips",
  "candy",
  "protein",
  "drinks",
  "gum",
];

// ÂàÜÁ±ªÊòæÁ§∫ÈÖçÁΩÆÔºöÂÖàÊåâÊ†áÂáÜÂàÜÁ±ªÊò†Â∞ÑÔºõÊú™Áü•ÂàÜÁ±ªËµ∞Â§áÁî®ÂõæÊ†áÊ±†
const SHOW_CATEGORY_ICON = true;
const CATEGORY_META = {
  cookies: { icon: "üç™", label: "Galletas y dulces horneados" },
  chips: { icon: "ü•î", label: "Papas y botanas crujientes" },
  candy: { icon: "üç¨", label: "Dulces y chocolates" },
  protein: { icon: "üí™", label: "Barras de prote√≠na" },
  drinks: { icon: "ü•§", label: "Bebidas" },
  gum: { icon: "üçÉ", label: "Chicles" },
  promotion: { icon: "üè∑Ô∏è", label: "Promociones" },
};
const PROMOTION_CATEGORY_KEYS = new Set(["promotion"]);
const FALLBACK_CATEGORY_ICONS = ["üß∫", "üç±", "üçø", "üç©", "ü•®", "üßÉ", "üçì", "ü•ú", "üç´", "üßÅ"];
const FALLBACK_CATEGORY_ICON_OVERRIDES = {
  // Á§∫‰æãÔºö"limited special": "üåü",
};
const fallbackCategoryIconCache = new Map();
const fallbackCategoryIconUsage = new Map(FALLBACK_CATEGORY_ICONS.map(icon => [icon, 0]));

function normalizeCategoryKey(v){
  return String(v || "").trim().toLowerCase();
}

function isPromotionCategory(category){
  return PROMOTION_CATEGORY_KEYS.has(normalizeCategoryKey(category));
}

function pickFallbackCategoryIcon(category){
  const key = normalizeCategoryKey(category);

  if (FALLBACK_CATEGORY_ICON_OVERRIDES[key]){
    return FALLBACK_CATEGORY_ICON_OVERRIDES[key];
  }

  if (fallbackCategoryIconCache.has(key)){
    return fallbackCategoryIconCache.get(key);
  }

  if (!FALLBACK_CATEGORY_ICONS.length) return "üß∫";

  let hash = 0;
  const s = String(key || "");
  for (let i = 0; i < s.length; i++) hash = ((hash << 5) - hash) + s.charCodeAt(i);

  const start = Math.abs(hash) % FALLBACK_CATEGORY_ICONS.length;
  let bestIcon = FALLBACK_CATEGORY_ICONS[start];
  let bestUsage = Number.POSITIVE_INFINITY;

  for (let i = 0; i < FALLBACK_CATEGORY_ICONS.length; i++){
    const idx = (start + i) % FALLBACK_CATEGORY_ICONS.length;
    const icon = FALLBACK_CATEGORY_ICONS[idx];
    const usage = fallbackCategoryIconUsage.get(icon) || 0;

    if (usage < bestUsage){
      bestUsage = usage;
      bestIcon = icon;
      if (usage === 0) break;
    }
  }

  fallbackCategoryIconCache.set(key, bestIcon);
  fallbackCategoryIconUsage.set(bestIcon, (fallbackCategoryIconUsage.get(bestIcon) || 0) + 1);
  return bestIcon;
}

function getCategoryLabelHtml(category){
  const raw = String(category || "Other").trim() || "Other";
  const key = normalizeCategoryKey(raw);
  const meta = CATEGORY_META[key];
  const text = meta ? meta.label : raw;
  if (!SHOW_CATEGORY_ICON) return escapeHtml(text);
  const icon = meta ? meta.icon : pickFallbackCategoryIcon(raw);
  return `${icon} ${escapeHtml(text)}`;
}

function getCategoryOrderIndex(category){
  return CATEGORY_ORDER.indexOf(normalizeCategoryKey(category));
}

function fmtPrice(n){
  const v = Number(n);
  return Number.isFinite(v) ? `$${v.toFixed(2)}` : "$0.00";
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function parsePrice(text){
  const n = Number(String(text || "").replace(/[^0-9.]/g, ""));
  return Number.isFinite(n) ? n : 0;
}

function isUnavailableBadgeText(text){
  const badgeText = String(text || "").trim().toLowerCase();
  if (!badgeText) return false;
  return /out\s*of\s*stock|coming\s*up\s*soon|coming\s*soon|non[-\s]?orderable|sold\s*out|unavailable/.test(badgeText);
}

function isComingSoonBadgeText(text){
  const badgeText = String(text || "").trim().toLowerCase();
  if (!badgeText) return false;
  return /coming\s*up\s*soon|coming\s*soon/.test(badgeText);
}

function getBadgeMeta(product){
  const badgeText = String(product?.badge || "").trim();
  if (isPromotionCategory(product?.category)){
    return {
      type: "promo",
      text: badgeText || "Promotion",
      icon: "üè∑Ô∏è",
      unavailable: true,
    };
  }

  const stockStatus = String(product?.stock_status || "").toLowerCase();
  const isOutByStatus = stockStatus === "out_of_stock" || stockStatus === "non_orderable";
  const isOutByFlag = product?.orderable === false || product?.is_orderable === false;
  const isOutByText = isUnavailableBadgeText(badgeText);
  const isOutOfStock = isOutByStatus || isOutByFlag || isOutByText;
  const isComingSoon = isComingSoonBadgeText(badgeText);

  if (isOutOfStock){
    return {
      type: isComingSoon ? "soon" : "oos",
      text: badgeText || (isComingSoon ? "Coming Up Soon" : "Out of Stock"),
      icon: isComingSoon ? "üîú" : "‚õî",
      unavailable: true,
    };
  }

  if (!badgeText) return null;

  return {
    type: "best",
    text: badgeText,
    icon: "‚≠ê"
  };
}

/** =========================
 *  CART + QTY
 * ========================= */
const cart = {}; // { sku: qty }
const productMetaBySku = new Map();
const discountAmountBySku = new Map(); // sku -> discount amount ($)

function getQty(sku){ return cart[sku] || 0; }

function toWholeQty(v){
  return Math.max(0, Math.floor(Number(v) || 0));
}

function roundMoney(v){
  return Math.round((Number(v) || 0) * 100) / 100;
}

function roundPortionQty(v){
  return Math.round((Number(v) || 0) * 10000) / 10000;
}

function getUnitPrice(sku){
  const meta = productMetaBySku.get(String(sku));
  const price = Number(meta?.sellPrice || 0);
  return Number.isFinite(price) ? price : 0;
}

function getDiscountAmountTotal(){
  let total = 0;
  for (const amount of discountAmountBySku.values()){
    total += roundMoney(amount);
  }
  return roundMoney(total);
}

function discountAmountToPortionQty(sku, amount){
  const unitPrice = getUnitPrice(sku);
  if (!(unitPrice > 0)) return 0;
  return roundPortionQty(roundMoney(amount) / unitPrice);
}

function getDiscountPortionTotal(){
  let total = 0;
  for (const [sku, amount] of discountAmountBySku.entries()){
    total += discountAmountToPortionQty(sku, amount);
  }
  return roundPortionQty(total);
}

function setQty(sku, qty){
  const meta = productMetaBySku.get(String(sku));
  if (meta && meta.orderable === false){
    delete cart[sku];
    discountAmountBySku.delete(String(sku));
    updateUI();
    return;
  }

  const q = Math.max(0, Math.floor(Number(qty) || 0));
  if (q === 0){
    delete cart[sku];
    discountAmountBySku.delete(String(sku));
  }else{
    cart[sku] = q;
  }

  updateUI();
  if (cartDrawer.classList.contains("open")) renderCartPreview();
  if (promotionModal.classList.contains("open")){
    refreshPromotionSkuOptions();
    renderPromotionList();
  }
}

function updateQtyControls(){
  document.querySelectorAll(".item[data-sku]").forEach(item=>{
    const sku = item.dataset.sku;
    const container = item.querySelector(".qty-control");
    if (!container) return;

    const orderable = item.dataset.orderable !== "false";
    if (!orderable){
      const meta = productMetaBySku.get(String(sku));
      const reason = String(meta?.unavailableLabel || "Unavailable");
      const unavailableType = String(meta?.unavailableType || "").toLowerCase();
      const typeClass = unavailableType ? ` qty-unavailable-${unavailableType}` : "";
      let text = "UNAVAILABLE";
      if (unavailableType === "soon") text = "COMING SOON";
      else if (unavailableType === "oos") text = "OUT OF STOCK";
      else if (unavailableType === "promo") text = "PROMOTION";
      container.innerHTML = `<span class="qty-unavailable${typeClass}" title="${escapeHtml(reason)}">${text}</span>`;
      return;
    }

    const qty = getQty(sku);
    if (qty === 0){
      container.innerHTML = `<button class="qty-btn plus" type="button">+</button>`;
    } else {
      container.innerHTML = `
        <button class="qty-btn minus" type="button">‚àí</button>
        <div class="qty-number">${qty}</div>
        <button class="qty-btn plus" type="button">+</button>
      `;
    }
  });
}

/** Âè™ÂÖÅËÆ∏ÁÇπ + / - ÊîπÊï∞ÈáèÔºàÁÇπÂà´ÁöÑÂú∞Êñπ‰∏ç‰∫§‰∫íÔºâ */
document.addEventListener("click",(e)=>{
  const plus = e.target.closest(".qty-btn.plus");
  const minus = e.target.closest(".qty-btn.minus");
  if (!plus && !minus) return;

  const item = e.target.closest(".item[data-sku]");
  if (!item) return;

  e.preventDefault();
  e.stopPropagation();

  const sku = item.dataset.sku;
  if (item.dataset.orderable === "false") return;
  if (plus) setQty(sku, getQty(sku) + 1);
  if (minus) setQty(sku, getQty(sku) - 1);
});

/** =========================
 *  Bottom bar + Drawer
 * ========================= */
const summaryTextEl = document.getElementById("sellSummaryText");
const sellBtnEl = document.getElementById("sellSubmit");
const promotionOpenBtnEl = document.getElementById("promotionOpen");
const clearBtnEl = document.getElementById("clearCart");
const giftBtnEl = document.getElementById("giftSubmit");

const cartDrawer = document.getElementById("cartDrawer");
const cartClose = document.getElementById("cartClose");
const cartItemsEl = document.getElementById("cartItems");
const cartTotalEl = document.getElementById("cartTotal");
const cartTotalPriceEl = document.getElementById("cartTotalPrice");
const cartDiscountPriceEl = document.getElementById("cartDiscountPrice");

const promotionModal = document.getElementById("promotionModal");
const promotionCloseBtn = document.getElementById("promotionClose");
const promotionApplyBtn = document.getElementById("promotionApply");
const promotionSkuSelect = document.getElementById("promotionSkuSelect");
const promotionAmountInput = document.getElementById("promotionAmountInput");
const promotionListEl = document.getElementById("promotionList");
let summaryOverrideText = "";
let summaryOverrideTimer = null;

/** ÁÇπ Cart ÊâçÊâìÂºÄ drawer */
document.querySelector(".sell-summary").addEventListener("click",()=>{
  if(Object.keys(cart).length === 0) return;
  renderCartPreview();
  cartDrawer.classList.add("open");
});

cartClose.addEventListener("click",()=> cartDrawer.classList.remove("open"));
cartDrawer.addEventListener("click",(e)=>{
  if(e.target === cartDrawer) cartDrawer.classList.remove("open");
});

function getPromotionCandidates(){
  return Object.keys(cart)
    .map((sku)=>({ sku, qty: Number(cart[sku] || 0), meta: productMetaBySku.get(String(sku)) }))
    .filter((item)=> item.qty > 0 && item.meta && item.meta.orderable !== false);
}

function refreshPromotionSkuOptions(){
  const candidates = getPromotionCandidates();
  const currentValue = String(promotionSkuSelect.value || "");
  promotionSkuSelect.innerHTML = "";

  for (const item of candidates){
    const option = document.createElement("option");
    option.value = item.sku;
    option.textContent = `${item.meta.name || item.sku} (x${item.qty})`;
    promotionSkuSelect.appendChild(option);
  }

  if (!candidates.length) return;
  if (candidates.some((item)=> item.sku === currentValue)){
    promotionSkuSelect.value = currentValue;
  } else {
    promotionSkuSelect.value = candidates[0].sku;
  }
}

function renderPromotionList(){
  const rows = [];
  for (const [sku, discountAmount] of discountAmountBySku.entries()){
    if (!cart[sku]) continue;
    const meta = productMetaBySku.get(String(sku));
    const name = meta?.name || sku;
    const cartQty = toWholeQty(cart[sku]);
    const amount = roundMoney(discountAmount);
    rows.push({ sku, name, cartQty, amount });
  }

  if (!rows.length){
    promotionListEl.innerHTML = `<div class="promo-empty">No discount added.</div>`;
    return;
  }

  promotionListEl.innerHTML = rows.map((row)=>`
    <div class="promo-item">
      <div class="promo-item-main">
        <div class="promo-item-name">${escapeHtml(row.name)}</div>
        <div class="promo-item-meta">Cart qty: ${row.cartQty} ¬∑ Discount: ${fmtPrice(row.amount)}</div>
      </div>
      <button class="promo-item-remove" type="button" data-remove-discount="${encodeURIComponent(row.sku)}">Remove</button>
    </div>
  `).join("");
}

function openPromotionModal(){
  if (!getPromotionCandidates().length) return;
  refreshPromotionSkuOptions();
  renderPromotionList();
  promotionAmountInput.value = "";
  promotionModal.classList.add("open");
  promotionModal.setAttribute("aria-hidden", "false");
}

function closePromotionModal(){
  promotionModal.classList.remove("open");
  promotionModal.setAttribute("aria-hidden", "true");
}

promotionOpenBtnEl.addEventListener("click", openPromotionModal);
promotionCloseBtn.addEventListener("click", closePromotionModal);
promotionModal.addEventListener("click", (e)=>{
  if (e.target === promotionModal) closePromotionModal();
});

promotionApplyBtn.addEventListener("click", ()=>{
  const sku = String(promotionSkuSelect.value || "").trim();
  const cartQty = toWholeQty(cart[sku]);
  if (!sku || cartQty <= 0){
    setSummaryOverride("Select cart product first", 1800);
    return;
  }

  const unitPrice = getUnitPrice(sku);
  if (!(unitPrice > 0)){
    setSummaryOverride("Invalid product price", 2000);
    return;
  }

  const discountAmount = roundMoney(promotionAmountInput.value);
  if (!(discountAmount > 0)){
    setSummaryOverride("Enter discount amount", 1800);
    return;
  }
  const maxAmount = roundMoney(unitPrice * cartQty);
  if (discountAmount > maxAmount){
    setSummaryOverride(`Discount exceeds max ${fmtPrice(maxAmount)} for this cart qty`, 2600);
    return;
  }

  discountAmountBySku.set(sku, discountAmount);
  promotionAmountInput.value = "";
  renderPromotionList();
  updateUI();
  if (cartDrawer.classList.contains("open")) renderCartPreview();
});

promotionListEl.addEventListener("click", (e)=>{
  const btn = e.target.closest("[data-remove-discount]");
  if (!btn) return;
  const sku = decodeURIComponent(String(btn.getAttribute("data-remove-discount") || "").trim());
  if (!sku) return;
  discountAmountBySku.delete(sku);
  renderPromotionList();
  updateUI();
  if (cartDrawer.classList.contains("open")) renderCartPreview();
});

function updateUI(){
  for (const sku of Object.keys(cart)){
    const meta = productMetaBySku.get(String(sku));
    if (meta && meta.orderable === false){
      delete cart[sku];
      discountAmountBySku.delete(String(sku));
    }
  }

  for (const sku of Array.from(discountAmountBySku.keys())){
    const cartQty = toWholeQty(cart[sku]);
    if (cartQty <= 0){
      discountAmountBySku.delete(sku);
      continue;
    }
    const unitPrice = getUnitPrice(sku);
    const discountAmount = roundMoney(discountAmountBySku.get(sku));
    if (!(unitPrice > 0) || !(discountAmount > 0)){
      discountAmountBySku.delete(sku);
      continue;
    }
    const maxAmount = roundMoney(unitPrice * cartQty);
    if (discountAmount > maxAmount){
      discountAmountBySku.set(sku, maxAmount);
    }
  }

  updateQtyControls();
  if (promotionModal.classList.contains("open")){
    refreshPromotionSkuOptions();
    renderPromotionList();
  }

  const totalQty = Object.values(cart).reduce((a,b)=>a+b,0);
  const discountAmountTotal = getDiscountAmountTotal();
  let defaultSummary = "No items selected";

  const hasUnorderableInCart = Object.keys(cart).some((sku)=>{
    const meta = productMetaBySku.get(String(sku));
    return meta?.orderable === false;
  });

  if(totalQty === 0 || hasUnorderableInCart){
    sellBtnEl.disabled = true;
    promotionOpenBtnEl.disabled = true;
    clearBtnEl.disabled = true;
    if (giftBtnEl) giftBtnEl.disabled = true;
    closePromotionModal();
  }else{
    defaultSummary = `${totalQty} item(s)`;
    if (discountAmountTotal > 0){
      defaultSummary += ` ¬∑ Discount ${fmtPrice(discountAmountTotal)}`;
    }
    sellBtnEl.disabled = false;
    promotionOpenBtnEl.disabled = false;
    clearBtnEl.disabled = false;
    if (giftBtnEl) giftBtnEl.disabled = false;
  }

  summaryTextEl.textContent = summaryOverrideText || defaultSummary;
}

function setSummaryOverride(text, durationMs = 0){
  summaryOverrideText = String(text || "").trim();
  if (summaryOverrideTimer){
    clearTimeout(summaryOverrideTimer);
    summaryOverrideTimer = null;
  }
  updateUI();
  if (durationMs > 0){
    summaryOverrideTimer = setTimeout(()=>{
      summaryOverrideText = "";
      summaryOverrideTimer = null;
      updateUI();
    }, durationMs);
  }
}

function renderCartPreview(){
  cartItemsEl.innerHTML = "";
  let totalQty = 0;
  let totalPrice = 0;

  Object.keys(cart).forEach(sku=>{
    const qty = cart[sku];
    totalQty += qty;

    const item = document.querySelector(`.item[data-sku="${sku}"]`);
    if (!item) return;

    const imgEl = item.querySelector("img");
    const meta = productMetaBySku.get(String(sku));
    const unitPrice = Number(meta?.sellPrice || 0);
    totalPrice += unitPrice * qty;

    const wrapper = document.createElement("div");
    wrapper.className = "cart-item-row";
    wrapper.innerHTML = `
      <img src="${imgEl?.src || ""}" class="cart-item-img" alt="">
      <div class="cart-item-qty">√ó ${qty}</div>
    `;
    cartItemsEl.appendChild(wrapper);
  });

  cartTotalEl.textContent = `Total Items: ${totalQty}`;
  cartTotalPriceEl.textContent = `Total Price: ${fmtPrice(totalPrice)}`;
  const discountAmountTotal = getDiscountAmountTotal();
  cartDiscountPriceEl.textContent = discountAmountTotal > 0
    ? `Discount: -${fmtPrice(discountAmountTotal)}`
    : "";
}

/** Clear */
clearBtnEl.addEventListener("click",()=>{
  for(const k of Object.keys(cart)) delete cart[k];
  discountAmountBySku.clear();
  closePromotionModal();
  updateUI();
  if (cartDrawer.classList.contains("open")) renderCartPreview();
});

/** =========================
 *  Sell / Gift (Batch)
 * ========================= */
async function postJson(url, body, extraHeaders = {}){
  const res = await fetch(url, {
    method:"POST",
    headers: { "Content-Type":"application/json", ...extraHeaders },
    body: JSON.stringify(body),
  });
  const data = await res.json().catch(()=> ({}));
  if(!res.ok) throw new Error(data.detail || "Request failed");
  return data;
}

sellBtnEl.addEventListener("click", async ()=>{
  const skus = Object.keys(cart);
  if(!skus.length) return;

  // Â¶ÇÊûú‰Ω†ÂêéÁ´ØÊúâ PIN Ê†°È™åÂ∞±‰øùÁïôÔºõÊ≤°ÊúâÂ∞±Âà†ÊéâËøô 3 Ë°å
  const pin = prompt("Enter PIN to confirm sale:");
  if (!pin) return;

  const items = skus.map(sku => ({ sku, qty: cart[sku] }));
  const discountItems = skus
    .map((sku)=>{
      const lossAmount = roundMoney(discountAmountBySku.get(sku));
      return {
        sku,
        qty: lossAmount,
        loss_amount: lossAmount,
      };
    })
    .filter((item)=> item.qty > 0);

  sellBtnEl.disabled = true;
  promotionOpenBtnEl.disabled = true;
  clearBtnEl.disabled = true;
  setSummaryOverride("Submitting...");

  try{
    await postJson(apiUrl("api/sales/batch"), {
      items,
      request_id: crypto.randomUUID(),
      note: ""
    }, {
      "X-Sell-Pin": pin
    });

    let discountError = "";
    if (discountItems.length){
      try{
        await postJson(apiUrl("api/losses/batch"), {
          items: discountItems,
          request_id: crypto.randomUUID(),
          loss_type: "DISCOUNT",
          note: "Promotion discount amount"
        }, {
          "X-Sell-Pin": pin
        });
      }catch(err){
        discountError = err?.message || "Discount write failed";
      }
    }

    for(const k of Object.keys(cart)) delete cart[k];
    discountAmountBySku.clear();
    closePromotionModal();
    updateUI();
    if (cartDrawer.classList.contains("open")) cartDrawer.classList.remove("open");

    if (discountError){
      setSummaryOverride(`Sold, discount failed: ${discountError}`, 3200);
    }else{
      setSummaryOverride("Sold ‚úì", 1200);
    }
  }catch(err){
    setSummaryOverride(err?.message || "Sell failed", 3000);
  }finally{
    updateUI();
  }
});

giftBtnEl?.addEventListener("click", async ()=>{
  const skus = Object.keys(cart);
  if(!skus.length) return;

  const pin = prompt("Enter PIN to confirm gift:");
  if (!pin) return;

  giftBtnEl.disabled = true;
  setSummaryOverride("Submitting gift...");

  try{
    const items = skus.map((sku) => {
      const qty = cart[sku];
      const lossAmount = roundMoney(getUnitPrice(sku) * qty);
      return { sku, qty, loss_amount: lossAmount };
    });

    await postJson(apiUrl("api/losses/batch"), {
      items,
      request_id: crypto.randomUUID(),
      loss_type: "GIFT",
      note: "Gift loss amount included"
    }, {
      "X-Sell-Pin": pin
    });

    for(const k of Object.keys(cart)) delete cart[k];
    discountAmountBySku.clear();
    closePromotionModal();
    updateUI();
    if (cartDrawer.classList.contains("open")) cartDrawer.classList.remove("open");

    setSummaryOverride("Gift recorded ‚úì", 1200);
  }catch(err){
    setSummaryOverride(err?.message || "Gift failed", 3000);
  }finally{
    updateUI();
  }
});

/** =========================
 *  Image preview (delegation)
 *  ÂÖ≥ÈîÆÔºöÂõ†‰∏∫ item ÊòØÂä®ÊÄÅÁîüÊàêÁöÑ
 * ========================= */
const preview = document.querySelector('.image-preview');
const previewImage = document.querySelector('.image-preview-img');
const previewClose = document.querySelector('.image-preview-close');

function closePreview(){
  preview.classList.remove('is-open');
  preview.setAttribute('aria-hidden', 'true');
  previewImage.src = '';
  previewImage.alt = '';
  document.body.classList.remove('preview-open');
}

document.addEventListener("click", (event) => {
  const link = event.target.closest(".item a");
  if (!link) return;

  event.preventDefault();
  const img = link.querySelector("img");
  previewImage.src = link.getAttribute("href");
  previewImage.alt = img ? img.alt : "Vista previa";
  preview.classList.add("is-open");
  preview.setAttribute("aria-hidden","false");
  document.body.classList.add("preview-open");
});

preview.addEventListener('click', (event) => {
  if (event.target === preview) closePreview();
});
previewClose.addEventListener('click', closePreview);
document.addEventListener('keydown', (event) => {
  if (event.key !== 'Escape') return;
  if (preview.classList.contains('is-open')) closePreview();
  if (promotionModal.classList.contains("open")) closePromotionModal();
});

/** =========================
 *  AUTO RENDER MENU
 * ========================= */
function apiUrl(path){
  const normalizedPath = String(path || "").replace(/^\/+/, "");
  return `${API_BASE}/${normalizedPath}`;
}

async function loadProducts(){
  const endpoint = apiUrl("api/products");
  const attempts = [
    {
      label: "header-auth",
      url: endpoint,
      options: { headers: { "X-API-Key": API_KEY } }
    },
    {
      label: "query-auth",
      url: `${endpoint}?api_key=${encodeURIComponent(API_KEY)}`,
      options: {}
    },
    {
      label: "public",
      url: endpoint,
      options: {}
    }
  ];

  const errors = [];

  for (const attempt of attempts){
    try{
      const res = await fetch(attempt.url, attempt.options);
      if (res.ok) return await res.json(); // [{sku,name,category,sell_price,image_url,badge}]

      const reason = (await res.text().catch(()=>"")).trim();
      errors.push(`${attempt.label}: ${res.status}${reason ? ` ${reason}` : ""}`);

      if (res.status !== 401 && res.status !== 403) break;
    }catch(err){
      errors.push(`${attempt.label}: ${err?.message || "network error"}`);
    }
  }

  throw new Error(`Failed to load products (${errors.join(" | ")})`);
}

function groupByCategory(products){
  const map = new Map();
  for (const p of products){
    const cat = String(p.category || "Other").trim();
    if (!map.has(cat)) map.set(cat, []);
    map.get(cat).push(p);
  }
  return map;
}

function sortCategories(cats){
  return cats.sort((a,b)=>{
    const ia = getCategoryOrderIndex(a);
    const ib = getCategoryOrderIndex(b);
    if (ia === -1 && ib === -1) return a.localeCompare(b);
    if (ia === -1) return 1;
    if (ib === -1) return -1;
    return ia - ib;
  });
}

function renderMenu(products){
  productMetaBySku.clear();

  const groups = groupByCategory(products);
  const categories = sortCategories(Array.from(groups.keys()));

  menuRoot.innerHTML = "";

  for (const cat of categories){
    const label = getCategoryLabelHtml(cat);

    const catDiv = document.createElement("div");
    catDiv.className = "category";
    catDiv.innerHTML = `<h2 class="category-title">${label}</h2>`;  

    const items = groups.get(cat) || [];
    items.sort((x,y)=> String(x.sku).localeCompare(String(y.sku)));

    for (const p of items){
      const badge = getBadgeMeta(p);
      const badgeText = badge?.text || "";
      const showNameBadge = badge && badge.unavailable !== true;
      const badgeHtml = showNameBadge
        ? `<span class="item-badge item-badge-${badge.type}"><span class="item-badge-icon" aria-hidden="true">${badge.icon}</span>${escapeHtml(badge.text)}</span>`
        : "";

      const imgUrl = String(p.image_url || "").trim();
      const orderableByFlag = p.orderable !== false && p.is_orderable !== false;
      const orderableByCategory = !isPromotionCategory(p.category);
      const orderableByBadge = !(badge && badge.unavailable === true);
      const orderable = orderableByFlag && orderableByBadge && orderableByCategory;
      const unavailableType = !orderable && !orderableByCategory
        ? "promo"
        : (badge?.type || "");
      const unavailableLabel = !orderable && !orderableByCategory
        ? "Promotion display only"
        : (badge?.text || (orderable ? "" : "Unavailable"));

      productMetaBySku.set(String(p.sku), {
        orderable,
        badge: badgeText,
        unavailableType,
        unavailableLabel,
        category: String(p.category || ""),
        name: String(p.name || ""),
        sellPrice: Number(p.sell_price || 0),
      });

      const item = document.createElement("div");
      const itemClasses = ["item"];
      if (!orderable) itemClasses.push("is-unorderable");
      if (!orderable && unavailableType === "promo") itemClasses.push("is-promo-display");
      item.className = itemClasses.join(" ");
      item.setAttribute("data-sku", p.sku);
      item.setAttribute("data-orderable", orderable ? "true" : "false");

      item.innerHTML = `
        <a href="${escapeHtml(imgUrl)}">
          <img loading="lazy" src="${escapeHtml(imgUrl)}" alt="${escapeHtml(p.name)}">
        </a>
        <div class="item-name">${escapeHtml(p.name)} ${badgeHtml}</div>
        <div class="item-price">${fmtPrice(p.sell_price)}</div>
        <div class="qty-control"></div>
      `;

      catDiv.appendChild(item);
    }

    menuRoot.appendChild(catDiv);
  }

  updateUI();
}

(async function init(){
  try{
    const products = await loadProducts();
    renderMenu(products);
    updateUI();
  }catch(e){
    console.error(e);
    menuRoot.innerHTML = `<div style="padding:16px;font-weight:900;">Failed to load menu.</div>`;
  }
})();
</script>
</body>
</html>
